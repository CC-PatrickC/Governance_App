{% extends 'base_cc.html' %}
{% load static %}

{% block title %}Request Triage{% endblock %}

{% block extra_head %}
{% csrf_token %}
{% endblock %}

{% block extra_css %}
<style>
    /* CC Theme Styles for Triage Page */
    .cc-triage-section {
        margin-bottom: 40px;
    }

    .cc-triage-header h3 {
        color: #000000;
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 24px;
    }

    .cc-filters-section {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .cc-filters-header {
        margin-bottom: 1rem;
    }

    .cc-filters-header h3 {
        color: #000000;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0;
    }

    .cc-filters-form {
        margin-bottom: 0;
    }

    .cc-filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
        margin-bottom: 8px;
    }

    .cc-filter-group {
        display: flex;
        flex-direction: column;
    }

    .cc-filter-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 3px;
    }

    .cc-filter-select {
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.875rem;
        background: white;
        color: #495057;
        transition: border-color 0.15s ease-in-out;
    }

    .cc-filter-select:focus {
        outline: none;
        border-color: #000000;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
    }

    .cc-clear-filters {
        text-align: center;
        padding-top: 8px;
        border-top: 1px solid #e9ecef;
    }

    .cc-clear-btn {
        color: #6c757d;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 4px;
        transition: all 0.15s ease-in-out;
    }

    .cc-clear-btn:hover {
        color: #000000;
        background: #e9ecef;
        text-decoration: none;
    }

    .cc-projects-section {
        margin-bottom: 2rem;
    }

    .cc-projects-header {
        margin-bottom: 1.5rem;
    }

    .cc-projects-header h3 {
        color: #000000;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0;
    }

    .cc-projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .cc-project-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        cursor: pointer;
    }

    .cc-project-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .cc-project-header {
        background: linear-gradient(135deg, #D09B2C 0%, #E6B84C 100%);
        color: black;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cc-project-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin: 0;
    }

    .cc-project-id {
        font-size: 0.875rem;
        font-weight: 500;
        opacity: 0.8;
    }

    .cc-project-body {
        padding: 1.5rem;
    }

    .cc-project-description {
        color: #495057;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .cc-project-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 20px;
    }

    .cc-meta-section {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .cc-meta-title {
        font-size: 8px;
        font-weight: 600;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .cc-meta-item {
        background: #f8f9fa;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .cc-priority-high {
        background: #f8d7da;
        color: #721c24;
    }

    .cc-priority-medium {
        background: #fff3cd;
        color: #856404;
    }

    .cc-priority-low {
        background: #d1ecf1;
        color: #0c5460;
    }

    .cc-department-section {
        margin-top: 12px;
    }

    .cc-department-title {
        font-size: 8px;
        font-weight: 600;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }



    .cc-project-meta-requested {
        font-size: 0.85em;
        color: #6c757d;
        margin-bottom: 1rem;
        font-style: italic;
    }

    .cc-project-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .cc-action-btn {
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.15s ease-in-out;
        border: 1px solid transparent;
    }

    .cc-action-primary {
        background: #D09B2C;
        color: white;
        border-color: #D09B2C;
    }

    .cc-action-primary:hover {
        background: #B8860B;
        border-color: #B8860B;
        color: white;
        text-decoration: none;
    }

    .cc-action-secondary {
        background: #6c757d;
        color: white;
        border-color: #6c757d;
    }

    .cc-action-secondary:hover {
        background: #5a6268;
        border-color: #5a6268;
        color: white;
        text-decoration: none;
    }

    .cc-empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    .cc-empty-state h4 {
        margin-bottom: 1rem;
        color: #495057;
    }

    /* CC Button Styles */
    .cc-btn-primary {
        background: #D09B2C;
        border: 1px solid #D09B2C;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.15s ease-in-out;
    }

    .cc-btn-primary:hover {
        background: #B8860B;
        border-color: #B8860B;
        color: white;
        text-decoration: none;
    }

    .cc-btn-secondary {
        background: #6c757d;
        border: 1px solid #6c757d;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.15s ease-in-out;
    }

    .cc-btn-secondary:hover {
        background: #5a6268;
        border-color: #5a6268;
        color: white;
        text-decoration: none;
    }

    /* Card Link Styling */
    .cc-card-link {
        display: block;
        text-decoration: none;
        color: inherit;
    }

    .cc-card-link:hover {
        text-decoration: none;
        color: inherit;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .cc-projects-grid {
            grid-template-columns: 1fr;
        }
        
        .cc-filters-grid {
            grid-template-columns: 1fr;
        }
        
        .cc-project-actions {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Main Content Area -->
<div class="container">
    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="cc-triage-header">
            <h3>Request Triage</h3>
        </div>
        <div class="d-flex gap-2">
            <button id="refreshButton" class="cc-btn-secondary" onclick="refreshProjects()">
                Refresh
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="cc-filters-section">
        <div class="cc-filters-header">
            <h3>Filter Requests</h3>
        </div>
        <form method="get" class="cc-filters-form">
            {% if search_query %}
            <input type="hidden" name="search" value="{{ search_query }}">
            {% endif %}
            <div class="cc-filters-grid">
                <!-- Project Type Filter -->
                <div class="cc-filter-group">
                    <label class="cc-filter-label">Request Type</label>
                    <select name="type" class="cc-filter-select" onchange="this.form.submit()">
                        <option value="">All Types</option>
                        {% if project_types %}
                            {% for value, label in project_types %}
                            <option value="{{ value }}" {% if type_filter == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- Priority Filter -->
                <div class="cc-filter-group">
                    <label class="cc-filter-label">Priority</label>
                    <select name="priority" class="cc-filter-select" onchange="this.form.submit()">
                        <option value="">All Priorities</option>
                        {% if priorities %}
                            {% for priority in priorities %}
                            <option value="{{ priority }}" {% if priority_filter == priority %}selected{% endif %}>{{ priority }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="cc-filter-group">
                    <label class="cc-filter-label">Status</label>
                    <select name="status" class="cc-filter-select" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        {% if status_choices %}
                            {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- Department Filter -->
                <div class="cc-filter-group">
                    <label class="cc-filter-label">Department</label>
                    <select name="department" class="cc-filter-select" onchange="this.form.submit()">
                        <option value="">All Departments</option>
                        {% if departments %}
                            {% for dept in departments %}
                            <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            
            <!-- Clear Filters -->
            {% if type_filter or priority_filter or status_filter or department_filter %}
            <div class="cc-clear-filters">
                <a href="?{% if search_query %}search={{ search_query }}{% endif %}" class="cc-clear-btn">Clear All Filters</a>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Projects Section -->
    <div class="cc-projects-section">
        <div class="cc-projects-header">
            <h3>Requests ({{ projects|length }})</h3>
        </div>
        
        {% if projects %}
        <div class="cc-projects-grid">
            {% for project in projects %}
            <div class="cc-project-card" data-project-id="{{ project.id }}" style="cursor: pointer;">
                <div class="cc-project-header">
                    <div class="cc-project-title">{{ project.title }}</div>
                    <div class="cc-project-id">{{ project.formatted_id }}</div>
                </div>
                <div class="cc-project-body">
                    <div class="cc-project-description">
                        {{ project.description|truncatechars:120 }}
                    </div>
                    <div class="cc-project-meta">
                        <div class="cc-meta-section">
                            <div class="cc-meta-title">Request Type</div>
                            <span class="cc-meta-item">{{ project.get_project_type_display }}</span>
                        </div>
                        <div class="cc-meta-section">
                            <div class="cc-meta-title">Priority</div>
                            <span class="cc-meta-item cc-priority-{{ project.priority|lower }}">{{ project.priority }}</span>
                        </div>
                        <div class="cc-meta-section">
                            <div class="cc-meta-title">Status</div>
                            <span class="cc-meta-item">{{ project.get_status_display }}</span>
                        </div>
                    </div>
                    
                    {% if project.department %}
                    <div class="cc-department-section">
                        <div class="cc-department-title">Department</div>
                        <span class="cc-meta-item">{{ project.department }}</span>
                    </div>
                    {% endif %}

                    <div class="cc-project-meta-requested">
                        Requested by: 
                        {% if project.submitted_by %}
                            {{ project.submitted_by.get_full_name|default:project.submitted_by.username }}
                        {% else %}
                            Unknown
                        {% endif %}
                        on {{ project.submission_date|date:'M d, Y' }}
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="cc-empty-state">
            <h4>No requests found</h4>
            <p>Try adjusting your search criteria or filters.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #D09B2C 0%, #E6B84C 100%); color: black;">
                <h5 class="modal-title" id="editProjectModalLabel">Edit Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editFormContainer">
                    <!-- Edit form will be loaded here -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading edit form...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProjectBtn" style="display: none;">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add click event listeners to project cards
    const projectCards = document.querySelectorAll('.cc-project-card');
    projectCards.forEach(function(card) {
        card.addEventListener('click', function(e) {
            const projectId = this.getAttribute('data-project-id');
            if (!projectId) {
                console.error('No project ID found');
                return;
            }
            
            // Show modal and load edit form
            openEditModal(projectId);
        });
    });
});

function openEditModal(projectId) {
    const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
    const formContainer = document.getElementById('editFormContainer');
    const saveBtn = document.getElementById('saveProjectBtn');
    
    // Show loading state
    formContainer.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading edit form...</p>
        </div>
    `;
    
    // Show modal
    modal.show();
    
    // Load the edit form via AJAX
    fetch(`/${projectId}/edit-form/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(html => {
            // Replace form content with the clean form HTML
            formContainer.innerHTML = html;
            
            // Get the form element
            const form = formContainer.querySelector('form');
            
            if (form) {
                // Update form action to submit via AJAX
                form.action = `/${projectId}/update/`;
                form.method = 'POST';
                
                // Show save button
                saveBtn.style.display = 'inline-block';
                
                // Add form submit handler
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitEditForm(form, projectId);
                });
                
                // Add click handler to save button
                saveBtn.addEventListener('click', function() {
                    form.dispatchEvent(new Event('submit'));
                });
            } else {
                formContainer.innerHTML = '<div class="alert alert-danger">Error loading edit form</div>';
            }
        })
        .catch(error => {
            console.error('Error loading edit form:', error);
            formContainer.innerHTML = '<div class="alert alert-danger">Error loading edit form</div>';
        });
}

function submitEditForm(form, projectId) {
    const formData = new FormData(form);
    const saveBtn = document.getElementById('saveProjectBtn');
    const formContainer = document.getElementById('editFormContainer');
    
    // Disable save button and show loading
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    
    fetch(`/${projectId}/update/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            formContainer.innerHTML = `
                <div class="alert alert-success">
                    <h5>Project Updated Successfully!</h5>
                    <p>${data.message}</p>
                </div>
            `;
            
            // Hide save button
            saveBtn.style.display = 'none';
            
            // Reload page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            // Show error message
            formContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h5>Error Updating Project</h5>
                    <p>${data.message}</p>
                </div>
            `;
            
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'Save Changes';
        }
    })
    .catch(error => {
        console.error('Error submitting form:', error);
        formContainer.innerHTML = `
            <div class="alert alert-danger">
                <h5>Error Updating Project</h5>
                <p>An error occurred while saving the project.</p>
            </div>
        `;
        
        // Re-enable save button
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'Save Changes';
    });
}

function refreshProjects() {
    const button = document.getElementById('refreshButton');
    
    // Disable button
    button.disabled = true;
    
    // Reload the page
    window.location.reload();
}


</script>

{% endblock %} 