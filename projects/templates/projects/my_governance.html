{% extends 'base_cc.html' %}

{% block title %}MyGovernance{% endblock %}

{% block extra_css %}
{% csrf_token %}
<style>
    .cc-content-area {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 2rem;
        margin-top: 1rem;
    }

    .cc-section-header {
        border-bottom: 2px solid #D09B2C;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }

    .cc-section-header h2 {
        color: #2c3e50;
        margin: 0;
        font-weight: 600;
    }

    .cc-projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .cc-project-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        overflow: hidden;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        cursor: pointer;
    }

    .cc-project-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .cc-project-header {
        background: linear-gradient(135deg, #D09B2C 0%, #E6B84C 100%);
        color: black;
        padding: 0.4rem 0.6rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cc-project-title {
        font-weight: 600;
        font-size: 0.85rem;
        margin: 0;
        color: white;
    }

    .cc-project-id {
        font-size: 0.7rem;
        font-weight: 500;
        opacity: 0.8;
        color: black;
    }

    .cc-project-body {
        padding: 0.6rem;
    }

    .cc-project-description {
        color: #495057;
        margin-bottom: 0.4rem;
        line-height: 1.2;
        font-size: 0.8rem;
        max-height: 1.9rem;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
    }

    .cc-project-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
    }

    .cc-meta-section {
        display: flex;
        flex-direction: column;
        gap: 1px;
    }

    .cc-meta-title {
        font-size: 0.6rem;
        font-weight: 600;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1px;
    }

    .cc-meta-item {
        background: #f8f9fa;
        color: #495057;
        padding: 0.1rem 0.25rem;
        border-radius: 2px;
        font-size: 0.6rem;
        font-weight: 500;
    }

    .cc-priority-high {
        background: #f8d7da;
        color: #721c24;
    }

    .cc-priority-medium {
        background: #fff3cd;
        color: #856404;
    }

    .cc-priority-low {
        background: #d1ecf1;
        color: #0c5460;
    }

    .cc-department-section {
        margin-top: 6px;
    }

    .cc-department-title {
        font-size: 0.6rem;
        font-weight: 600;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1px;
    }

    .cc-project-meta-requested {
        font-size: 0.6rem;
        color: #6c757d;
        margin-top: 0.4rem;
        padding-top: 0.4rem;
        border-top: 1px solid #e9ecef;
    }

    .cc-empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .cc-empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .cc-empty-state h4 {
        margin-bottom: 0.5rem;
        color: #495057;
    }

    .cc-empty-state p {
        margin-bottom: 1.5rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .cc-projects-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Modal Styles */
    
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #D09B2C 0%, #E6B84C 100%);
        color: black;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        padding: 1.5rem;
    }
    
    .modal-title {
        font-weight: 600;
        font-size: 1.25rem;
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .modal-footer {
        border-top: 1px solid #e9ecef;
        padding: 1rem 2rem;
        background: #f8f9fa;
        border-radius: 0 0 12px 12px;
    }
    
    /* Request Details Section Styling */
    .request-details-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .detail-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        height: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease-in-out;
    }
    
    .detail-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .detail-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #D09B2C;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .detail-content p {
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        line-height: 1.4;
    }
    
    .detail-content strong {
        color: #495057;
        font-weight: 600;
    }
    
    .detail-content .text-muted {
        color: #6c757d !important;
    }
    
         /* Project Title Styling */
     .project-title {
         color: #495057;
         font-weight: 600;
         margin-bottom: 0;
         padding: 0.5rem 1rem;
         background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
         border-radius: 6px;
         border-left: 4px solid #D09B2C;
     }
     
     /* Attachment Styling */
     .attachment-item {
         padding: 0.5rem;
         background: #f8f9fa;
         border-radius: 4px;
         border: 1px solid #e9ecef;
         transition: all 0.2s ease-in-out;
     }
     
     .attachment-item:hover {
         background: #e9ecef;
         border-color: #D09B2C;
     }
     
     .attachment-item a {
         color: #495057;
         font-weight: 500;
     }
     
     .attachment-item a:hover {
         color: #D09B2C;
     }
     
     .attachment-item i {
         margin-right: 0.5rem;
         color: #D09B2C;
     }
     
     /* Meeting Notes and Notifications Styling */
     .cc-notification-card,
     .cc-meeting-notes-card {
         background: white;
         border: 1px solid #e9ecef;
         border-radius: 6px;
         overflow: hidden;
         box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
         height: 100%;
     }
     
     .cc-notification-header,
     .cc-meeting-notes-header {
         background: linear-gradient(135deg, #D09B2C 0%, #E6B84C 100%);
         color: white;
         padding: 0.75rem 1rem;
         display: flex;
         align-items: center;
         gap: 0.5rem;
     }
     
     .cc-notification-header h4,
     .cc-meeting-notes-header h4 {
         margin: 0;
         font-weight: 600;
         font-size: 1rem;
     }
     
     .cc-notification-list,
     .cc-meeting-notes-list {
         padding: 0.4rem;
         max-height: 250px;
         overflow-y: auto;
     }
     
     .cc-notification-item {
         display: flex;
         gap: 0.4rem;
         padding: 0.4rem;
         border-bottom: 1px solid #f1f3f4;
         transition: background-color 0.2s ease;
     }
     
     .cc-notification-item:last-child {
         border-bottom: none;
     }
     
     .cc-notification-item:hover {
         background-color: #f8f9fa;
     }
     
     .cc-notification-icon {
         flex-shrink: 0;
         width: 24px;
         height: 24px;
         display: flex;
         align-items: center;
         justify-content: center;
         border-radius: 50%;
         background: #f8f9fa;
     }
     
     .cc-notification-content {
         flex: 1;
     }
     
     .cc-notification-title {
         font-weight: 600;
         color: #2c3e50;
         margin-bottom: 0.2rem;
         font-size: 0.9rem;
     }
     
     .cc-notification-text {
         color: #6c757d;
         font-size: 0.75rem;
         line-height: 1.2;
         margin-bottom: 0.3rem;
     }
     
     .cc-notification-time {
         color: #adb5bd;
         font-size: 0.75rem;
         font-style: italic;
     }
     
     .cc-meeting-note-item {
         padding: 0.4rem;
         border-bottom: 1px solid #f1f3f4;
         transition: background-color 0.2s ease;
     }
     
     .cc-meeting-note-item:last-child {
         border-bottom: none;
     }
     
     .cc-meeting-note-item:hover {
         background-color: #f8f9fa;
     }
     
     .cc-meeting-note-header {
         display: flex;
         justify-content: space-between;
         align-items: flex-start;
         margin-bottom: 0.4rem;
     }
     
     .cc-meeting-note-title {
         font-weight: 600;
         color: #2c3e50;
         font-size: 0.9rem;
         line-height: 1.2;
     }
     
     .cc-meeting-note-date {
         color: #adb5bd;
         font-size: 0.75rem;
         font-style: italic;
         flex-shrink: 0;
         margin-left: 1rem;
     }
     
     .cc-meeting-note-summary {
         color: #6c757d;
         font-size: 0.75rem;
         line-height: 1.2;
         margin-bottom: 0.5rem;
     }
     
     .cc-meeting-note-actions {
         display: flex;
         gap: 0.5rem;
     }
     
     .cc-meeting-note-actions .btn {
         font-size: 0.8rem;
         padding: 0.25rem 0.75rem;
     }
     
     /* Responsive adjustments */
     @media (max-width: 768px) {
         .cc-meeting-note-header {
             flex-direction: column;
             align-items: flex-start;
         }
         
         .cc-meeting-note-date {
             margin-left: 0;
             margin-top: 0.25rem;
         }
         
         /* Make weighted scores bold */
         .weighted-score {
             font-weight: bold !important;
             color: black !important;
         }
         
         /* Ensure table cells with weighted scores are bold */
         .table .weighted-score {
             font-weight: bold !important;
             color: black !important;
         }
         
         /* Target specific weighted score elements */
         #strategic_alignment_weighted,
         #cost_benefit_weighted,
         #user_impact_weighted,
         #ease_of_implementation_weighted,
         #vendor_reputation_support_weighted,
         #security_compliance_weighted,
         #student_centered_weighted,
         #final_score_display {
             font-weight: bold !important;
             color: black !important;
         }
     }
     
     /* Request Information Section Styling */
     .request-info-section {
         background: #f8f9fa;
         border-radius: 8px;
         padding: 1.5rem;
         margin-bottom: 1.5rem;
         border: 1px solid #e9ecef;
     }
     
     .section-header {
         color: #495057;
         font-weight: 600;
         margin-bottom: 1rem;
         padding-bottom: 0.5rem;
         border-bottom: 2px solid #D09B2C;
         font-size: 1rem;
         text-transform: uppercase;
         letter-spacing: 0.5px;
     }
     
     .info-item {
         background: white;
         border: 1px solid #e9ecef;
         border-radius: 6px;
         padding: 0.75rem;
         height: 100%;
         box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
     }
     
     .info-item strong {
         color: #495057;
         font-weight: 600;
         font-size: 0.8rem;
         text-transform: uppercase;
         letter-spacing: 0.5px;
     }
     
     .info-value {
         color: #6c757d;
         font-size: 0.9rem;
         font-weight: 500;
         margin-top: 0.25rem;
         display: block;
     }
     
     /* Custom Modal Styling to match MyRequest modal */
     .modal-dialog[style*="300px"] .modal-content {
         border-radius: 8px;
         box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
         max-height: 80vh;
         overflow: hidden;
     }
     
     .modal-dialog[style*="300px"] .modal-header {
         background: #f8f9fa !important;
         padding: 15px 20px;
         border-bottom: 1px solid #dee2e6;
         border-radius: 8px 8px 0 0;
     }
     
     .modal-dialog[style*="300px"] .modal-title {
         margin: 0;
         font-size: 1.1rem;
         font-weight: 600;
         color: #333;
     }
     
     .modal-dialog[style*="300px"] .modal-body {
         padding: 20px;
         max-height: 60vh;
         overflow-y: auto;
     }
     
     .modal-dialog[style*="300px"] .modal-footer {
         background: #f8f9fa;
         padding: 15px 20px;
         border-top: 1px solid #dee2e6;
         border-radius: 0 0 8px 8px;
     }
     
     /* Compact styling for 300px modal */
     .modal-dialog[style*="300px"] .section-header.small {
         font-size: 0.9rem;
         margin-bottom: 0.75rem;
         padding-bottom: 0.25rem;
     }
     
     .modal-dialog[style*="300px"] .info-content.compact {
         padding: 1rem;
     }
     
     .modal-dialog[style*="300px"] .info-content.compact p {
         margin-bottom: 0.5rem;
         font-size: 0.8rem;
     }
     
     .modal-dialog[style*="300px"] .table-sm th,
     .modal-dialog[style*="300px"] .table-sm td {
         padding: 0.25rem 0.5rem;
         font-size: 0.8rem;
     }
     
     .info-stack {
         display: flex;
         flex-direction: column;
         gap: 0.75rem;
     }
     
     .info-stack .info-item {
         margin-bottom: 0;
     }
     
     .info-content {
         background: white;
         border: 1px solid #e9ecef;
         border-radius: 6px;
         padding: 1.5rem;
         box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
     }
     
     .info-content p {
         margin-bottom: 0.75rem;
         font-size: 0.9rem;
         line-height: 1.4;
     }
     
     .info-content p:last-child {
         margin-bottom: 0;
     }
     
     .info-content strong {
         color: #495057;
         font-weight: 600;
         margin-right: 0.5rem;
     }
     
     .contact-info-section {
         background: #f8f9fa;
         border-radius: 8px;
         padding: 1.5rem;
         margin-bottom: 1.5rem;
         border: 1px solid #e9ecef;
     }
     
     .description-section {
         background: #f8f9fa;
         border-radius: 8px;
         padding: 1.5rem;
         margin-bottom: 1.5rem;
         border: 1px solid #e9ecef;
     }
     
     .attachments-section {
         background: #f8f9fa;
         border-radius: 8px;
         padding: 1.5rem;
         margin-bottom: 1.5rem;
         border: 1px solid #e9ecef;
     }
     
     .attachment-item {
         display: flex;
         align-items: center;
         gap: 0.5rem;
         padding: 0.5rem;
         background: white;
         border: 1px solid #e9ecef;
         border-radius: 4px;
         margin-bottom: 0.5rem;
     }
     
     .attachment-item:last-child {
         margin-bottom: 0;
     }
     
     .attachment-link {
         color: #495057;
         text-decoration: none;
         font-weight: 500;
     }
     
     .attachment-link:hover {
         color: #D09B2C;
         text-decoration: underline;
     }
     
     /* Final Governance Table Styles */
     .cc-final-scoring-table-container {
         background: white;
         border: 1px solid #e9ecef;
         border-radius: 8px;
         overflow: hidden;
         box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
         height: 500px;
         overflow-y: auto;
     }
     
     .cc-final-scoring-table {
         width: 100%;
         border-collapse: collapse;
         font-size: 0.875rem;
     }
     
     .cc-final-scoring-table th {
         background: #D09B2C;
         color: white;
         font-weight: 600;
         padding: 12px 16px;
         text-align: left;
         border-bottom: 2px solid #B8860B;
         font-size: 0.75rem;
         text-transform: uppercase;
         letter-spacing: 0.5px;
         position: sticky;
         top: 0;
         z-index: 10;
     }
     
     .cc-final-scoring-table td {
         padding: 16px;
         border-bottom: 1px solid #f8f9fa;
         vertical-align: top;
     }
     
     .cc-final-scoring-table tr:hover {
         background-color: #f8f9fa;
     }
     
     .cc-project-id {
         font-weight: 600;
         color: #495057;
         font-size: 0.8rem;
     }
     
     .cc-project-title {
         font-weight: 600;
         color: #495057;
         margin-bottom: 0.5rem;
     }
     
     .cc-project-description {
         color: #6c757d;
         font-size: 0.8rem;
         margin-bottom: 0.5rem;
         line-height: 1.4;
     }
     
     .cc-project-requested {
         font-size: 0.75rem;
     }
     
     .cc-score-value {
         font-weight: 600;
         color: #495057;
     }
     
    .cc-priority-input {
        width: 60px;
        padding: 4px 8px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        font-size: 0.8rem;
        text-align: center;
    }
    
    /* Remove number input arrows/spinners */
    .cc-priority-input::-webkit-outer-spin-button,
    .cc-priority-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    .cc-priority-input[type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }
     
     .cc-priority-input:focus {
         outline: none;
         border-color: #D09B2C;
         box-shadow: 0 0 0 2px rgba(208, 155, 44, 0.25);
     }
     
     /* Custom Scrollbar Styling */
     .cc-final-scoring-table-container::-webkit-scrollbar {
         width: 8px;
     }
     
     .cc-final-scoring-table-container::-webkit-scrollbar-track {
         background: #f1f1f1;
         border-radius: 4px;
     }
     
     .cc-final-scoring-table-container::-webkit-scrollbar-thumb {
         background: #D09B2C;
         border-radius: 4px;
     }
     
     .cc-final-scoring-table-container::-webkit-scrollbar-thumb:hover {
         background: #B8860B;
     }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
                         <div class="cc-page-header">
                 <h1>MyGovernance</h1>
             </div>
            
            <!-- Meeting Notes and Notifications Section -->
            <div class="cc-content-area">
                <div class="cc-section-header">
                    <h2>Meeting Notes & Notifications</h2>
                    <p class="text-muted">Latest updates and important information</p>
                </div>
                
                <div class="row">
                    <!-- Notifications Column -->
                    <div class="col-md-6 mb-4">
                        <div class="cc-notification-card">
                            <div class="cc-notification-header">
                                <i class="fas fa-bell"></i>
                                <h4>Recent Notifications</h4>
                            </div>
                            <div class="cc-notification-list">
                                <div class="cc-notification-item">
                                    <div class="cc-notification-icon">
                                        <i class="fas fa-info-circle text-info"></i>
                                    </div>
                                    <div class="cc-notification-content">
                                        <div class="cc-notification-title">System Update</div>
                                        <div class="cc-notification-text">New scoring criteria have been implemented for project evaluation.</div>
                                        <div class="cc-notification-time">2 hours ago</div>
                                    </div>
                                </div>
                                
                                <div class="cc-notification-item">
                                    <div class="cc-notification-icon">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    </div>
                                    <div class="cc-notification-content">
                                        <div class="cc-notification-title">Deadline Reminder</div>
                                        <div class="cc-notification-text">Q4 project submissions close on December 15th.</div>
                                        <div class="cc-notification-time">1 day ago</div>
                                    </div>
                                </div>
                                
                                <div class="cc-notification-item">
                                    <div class="cc-notification-icon">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                    <div class="cc-notification-content">
                                        <div class="cc-notification-title">Request Approved</div>
                                        <div class="cc-notification-text">Your request #PRJ-045 has been approved and moved to implementation.</div>
                                        <div class="cc-notification-time">3 days ago</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Meeting Notes Column -->
                    <div class="col-md-6 mb-4">
                        <div class="cc-meeting-notes-card">
                            <div class="cc-meeting-notes-header">
                                <i class="fas fa-sticky-note"></i>
                                <h4>Latest Meeting Notes</h4>
                            </div>
                            <div class="cc-meeting-notes-list">
                                <div class="cc-meeting-note-item">
                                    <div class="cc-meeting-note-header">
                                        <div class="cc-meeting-note-title">IT Governance Committee - December 2024</div>
                                        <div class="cc-meeting-note-date">Dec 10, 2024</div>
                                    </div>
                                    <div class="cc-meeting-note-summary">
                                        <strong>Key Decisions:</strong> Approved 3 new projects, deferred 2 for additional review. Updated scoring matrix for 2025.
                                    </div>
                                    <div class="cc-meeting-note-actions">
                                        <a href="#" class="btn btn-sm btn-outline-primary">View Full Notes</a>
                                    </div>
                                </div>
                                
                                <div class="cc-meeting-note-item">
                                    <div class="cc-meeting-note-header">
                                        <div class="cc-meeting-note-title">Triage Review Session</div>
                                        <div class="cc-meeting-note-date">Dec 8, 2024</div>
                                    </div>
                                    <div class="cc-meeting-note-summary">
                                        <strong>Reviewed:</strong> 12 pending requests, moved 8 to scoring phase, 4 require additional information.
                                    </div>
                                    <div class="cc-meeting-note-actions">
                                        <a href="#" class="btn btn-sm btn-outline-primary">View Full Notes</a>
                                    </div>
                                </div>
                                
                                <div class="cc-meeting-note-item">
                                    <div class="cc-meeting-note-header">
                                        <div class="cc-meeting-note-title">Scoring Committee Meeting</div>
                                        <div class="cc-meeting-note-date">Dec 5, 2024</div>
                                    </div>
                                    <div class="cc-meeting-note-summary">
                                        <strong>Scored:</strong> 15 projects using new evaluation criteria. Top 5 projects identified for final review.
                                    </div>
                                    <div class="cc-meeting-note-actions">
                                        <a href="#" class="btn btn-sm btn-outline-primary">View Full Notes</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MyRequests Section -->
            <div class="cc-content-area">
                <div class="cc-section-header">
                    <h2>MyRequests</h2>
                    <p class="text-muted">Requests you have submitted</p>
                </div>
                
                {% if user_projects %}
                    <div class="cc-projects-grid">
                        {% for project in user_projects %}
                        <div class="cc-project-card" data-project-id="{{ project.id }}" style="cursor: pointer;" onclick="showProjectDetails({{ project.id }})">
                            <div class="cc-project-header">
                                <div class="cc-project-title">{{ project.title }}</div>
                                <div class="cc-project-id">#{{ project.id|stringformat:"03d" }}</div>
                            </div>
                            <div class="cc-project-body">
                                <div class="cc-project-description">
                                    {{ project.description|truncatechars:120 }}
                                </div>
                                <div class="cc-project-meta">
                                    {% if project.project_type %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Request Type</div>
                                        <span class="cc-meta-item">{{ project.get_project_type_display }}</span>
                                    </div>
                                    {% endif %}
                                    {% if project.priority %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Priority</div>
                                        <span class="cc-meta-item cc-priority-{{ project.priority|lower }}">{{ project.priority }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Status</div>
                                        <span class="cc-meta-item">{{ project.get_status_display }}</span>
                                    </div>
                                </div>
                                
                                {% if project.department %}
                                <div class="cc-department-section">
                                    <div class="cc-department-title">Department</div>
                                    <span class="cc-meta-item">{{ project.department }}</span>
                                </div>
                                {% endif %}

                                <div class="cc-project-meta-requested">
                                    Requested by: 
                                    {% if project.submitted_by %}
                                        {{ project.submitted_by.get_full_name|default:project.submitted_by.username }}
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                    on {{ project.submission_date|date:'M d, Y' }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="cc-empty-state">
                        <i class="fas fa-inbox"></i>
                        <h4>No Requests Yet</h4>
                        <p>You haven't submitted any requests yet.</p>
                        <a href="{% url 'projects:project_intake_form' %}" class="btn" style="background-color: #D09B2C; border-color: #D09B2C; color: white;">
                            <i class="fas fa-plus-circle"></i> Submit Your First Request
                        </a>
                    </div>
                {% endif %}
            </div>
            
            <!-- My Contact Requests Section -->
            <div class="cc-content-area" style="margin-top: 2rem;">
                <div class="cc-section-header">
                    <h2>My Contact Requests</h2>
                    <p class="text-muted">Requests where you are listed as the contact person</p>
                </div>
                
                {% if contact_projects %}
                    <div class="cc-projects-grid">
                        {% for project in contact_projects %}
                        <div class="cc-project-card" data-project-id="{{ project.id }}" style="cursor: pointer;" onclick="showProjectDetails({{ project.id }})">
                            <div class="cc-project-header">
                                <div class="cc-project-title">{{ project.title }}</div>
                                <div class="cc-project-id">#{{ project.id|stringformat:"03d" }}</div>
                            </div>
                            <div class="cc-project-body">
                                <div class="cc-project-description">
                                    {{ project.description|truncatechars:120 }}
                                </div>
                                <div class="cc-project-meta">
                                    {% if project.project_type %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Request Type</div>
                                        <span class="cc-meta-item">{{ project.get_project_type_display }}</span>
                                    </div>
                                    {% endif %}
                                    {% if project.priority %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Priority</div>
                                        <span class="cc-meta-item cc-priority-{{ project.priority|lower }}">{{ project.priority }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Status</div>
                                        <span class="cc-meta-item">{{ project.get_status_display }}</span>
                                    </div>
                                </div>
                                
                                {% if project.department %}
                                <div class="cc-department-section">
                                    <div class="cc-department-title">Department</div>
                                    <span class="cc-meta-item">{{ project.department }}</span>
                                </div>
                                {% endif %}

                                <div class="cc-project-meta-requested">
                                    Requested by: 
                                    {% if project.submitted_by %}
                                        {{ project.submitted_by.get_full_name|default:project.submitted_by.username }}
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                    on {{ project.submission_date|date:'M d, Y' }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="cc-empty-state">
                        <i class="fas fa-user-tie"></i>
                        <h4>No Contact Requests</h4>
                        <p>You are not listed as a contact person for any requests.</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Triage Section (Only visible for Triage Group and Triage Group Lead users) -->
            {% if is_triage_user or is_triage_lead_user %}
            <div class="cc-content-area" style="margin-top: 2rem;">
                <div class="cc-section-header">
                    <h2>Triage Requests ({{ triage_projects.count }})</h2>
                    <p class="text-muted">Requests pending triage review</p>
                </div>
                
                {% if triage_projects %}
                    <div class="cc-projects-grid">
                        {% for project in triage_projects %}
                        <div class="cc-project-card triage-card" data-project-id="{{ project.id }}" style="cursor: pointer;" onclick="openTriageEditModal({{ project.id }})">
                            <div class="cc-project-header">
                                <div class="cc-project-title">{{ project.title }}</div>
                                <div class="cc-project-id">#{{ project.id|stringformat:"03d" }}</div>
                            </div>
                            <div class="cc-project-body">
                                <div class="cc-project-description">
                                    {{ project.description|truncatechars:120 }}
                                </div>
                                <div class="cc-project-meta">
                                    {% if project.project_type %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Request Type</div>
                                        <span class="cc-meta-item">{{ project.get_project_type_display }}</span>
                                    </div>
                                    {% endif %}
                                    {% if project.priority %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Priority</div>
                                        <span class="cc-meta-item cc-priority-{{ project.priority|lower }}">{{ project.priority }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Status</div>
                                        <span class="cc-meta-item">{{ project.get_status_display }}</span>
                                    </div>
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Stage</div>
                                        <span class="cc-meta-item">{{ project.get_stage_display }}</span>
                                    </div>
                                </div>
                                
                                {% if project.department %}
                                <div class="cc-department-section">
                                    <div class="cc-department-title">Department</div>
                                    <span class="cc-meta-item">{{ project.department }}</span>
                                </div>
                                {% endif %}

                                <div class="cc-project-meta-requested">
                                    Requested by: 
                                    {% if project.submitted_by %}
                                        {{ project.submitted_by.get_full_name|default:project.submitted_by.username }}
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                    on {{ project.submission_date|date:'M d, Y' }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="cc-empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <h4>No Triage Requests</h4>
                        <p>There are no requests currently pending triage review.</p>
                    </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Governance Section (Only visible for Triage Group, AI Governance Group, AI Governance Group Lead, ERP Governance Group, ERP Governance Group Lead, IT Governance Group, IT Governance Group Lead, Process Improvement Group, and Process Improvement Group Lead users) -->
            {% if is_triage_user or is_ai_governance_user or is_ai_governance_lead_user or is_erp_governance_user or is_erp_governance_lead_user or is_it_governance_user or is_it_governance_lead_user or is_process_improvement_user or is_process_improvement_lead_user %}
            <div class="cc-content-area" style="margin-top: 2rem;">
                <div class="cc-section-header">
                    <h2>Under Review - Governance ({{ governance_projects.count }})</h2>
                    <p class="text-muted">Requests currently being reviewed by governance committee</p>
                </div>
                
                {% if governance_projects %}
                    <div class="cc-projects-grid">
                        {% for project in governance_projects %}
                        <div class="cc-project-card governance-card" data-project-id="{{ project.id }}" style="cursor: pointer;" onclick="openGovernanceScoringModal({{ project.id }})">
                            <div class="cc-project-header">
                                <div class="cc-project-title">{{ project.title }}</div>
                                <div class="cc-project-id">#{{ project.id|stringformat:"03d" }}</div>
                            </div>
                            <div class="cc-project-body">
                                <div class="cc-project-description">
                                    {{ project.description|truncatechars:120 }}
                                </div>
                                <div class="cc-project-meta">
                                    {% if project.project_type %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Request Type</div>
                                        <span class="cc-meta-item">{{ project.get_project_type_display }}</span>
                                    </div>
                                    {% endif %}
                                    {% if project.priority %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Priority</div>
                                        <span class="cc-meta-item cc-priority-{{ project.priority|lower }}">{{ project.priority }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Status</div>
                                        <span class="cc-meta-item">{{ project.get_status_display }}</span>
                                    </div>
                                    <div class="cc-meta-section">
                                        <div class="cc-meta-title">Stage</div>
                                        <span class="cc-meta-item">{{ project.get_stage_display }}</span>
                                    </div>
                                </div>
                                
                                {% if project.department %}
                                <div class="cc-department-section">
                                    <div class="cc-department-title">Department</div>
                                    <span class="cc-meta-item">{{ project.department }}</span>
                                </div>
                                {% endif %}

                                <div class="cc-project-meta-requested">
                                    Requested by: 
                                    {% if project.submitted_by %}
                                        {{ project.submitted_by.get_full_name|default:project.submitted_by.username }}
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                    on {{ project.submission_date|date:'M d, Y' }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="cc-empty-state">
                        <i class="fas fa-gavel"></i>
                        <h4>No Governance Requests</h4>
                        <p>There are no requests currently in the governance review phase.</p>
                    </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Final Governance Section (Only visible for Triage Group users) -->
            {% if is_triage_user %}
            <div class="cc-content-area" style="margin-top: 2rem;">
                <div class="cc-section-header">
                    <h2>Under Review - Final Governance ({{ final_governance_projects.count }})</h2>
                    <p class="text-muted">Requests in final governance review phase</p>
                </div>
                
                {% if final_governance_projects %}
                    <div class="cc-final-scoring-table-container">
                        <table class="cc-final-scoring-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Priority</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Final Score</th>
                                    <th>Final Priority</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in final_governance_projects %}
                                <tr class="cc-project-row" data-project-id="{{ project.id }}" style="cursor: pointer;">
                                    <td class="cc-project-id-cell" onclick="openFinalScoringModal({{ project.id }})">
                                        <span class="cc-project-id">{{ project.formatted_id }}</span>
                                    </td>
                                    <td class="cc-project-title-cell" onclick="openFinalScoringModal({{ project.id }})">
                                        <div class="cc-project-title">{{ project.title }}</div>
                                        <div class="cc-project-description">{{ project.description|truncatechars:80 }}</div>
                                        <div class="cc-project-requested">
                                            <small class="text-muted">
                                                Requested by: 
                                                {% if project.submitted_by %}
                                                    {{ project.submitted_by.get_full_name|default:project.submitted_by.username }}
                                                {% else %}
                                                    Unknown
                                                {% endif %}
                                                on {{ project.submission_date|date:'M d, Y' }}
                                            </small>
                                        </div>
                                    </td>
                                    <td class="cc-project-type-cell" onclick="openFinalScoringModal({{ project.id }})">
                                        <span class="cc-meta-item">{{ project.get_project_type_display }}</span>
                                    </td>
                                    <td class="cc-project-priority-cell" onclick="openFinalScoringModal({{ project.id }})">
                                        <span class="cc-meta-item cc-priority-{{ project.priority|lower }}">{{ project.priority }}</span>
                                    </td>
                                    <td class="cc-project-department-cell" onclick="openFinalScoringModal({{ project.id }})">
                                        {% if project.department %}
                                            {{ project.department }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="cc-project-status-cell" onclick="openFinalScoringModal({{ project.id }})">
                                        <span class="cc-meta-item">{{ project.get_status_display }}</span>
                                    </td>
                                    <td class="cc-project-score-cell" onclick="openFinalScoringModal({{ project.id }})">
                                        {% if project.final_score %}
                                            <span class="cc-score-value">{{ project.final_score|floatformat:2 }}</span>
                                        {% else %}
                                            <span class="cc-score-value text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="cc-project-final-priority-cell">
                                        <div class="cc-rank-display d-flex align-items-center">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary rank-arrow-btn rank-up-btn" 
                                                    data-project-id="{{ project.id }}"
                                                    data-current-rank="{{ project.final_priority|default:0 }}"
                                                    title="Move up in priority (lower rank number)"
                                                    style="padding: 2px 6px; margin-right: 2px;">
                                                <i class="fas fa-chevron-up"></i>
                                            </button>
                                            <input type="number" 
                                                   class="cc-priority-input final-priority-input" 
                                                   value="{{ project.final_priority|default:'' }}"
                                                   min="1"
                                                   data-project-id="{{ project.id }}"
                                                   placeholder="Rank"
                                                   onclick="event.stopPropagation();"
                                                   onkeypress="if(event.key==='Enter') updateFinalPriority({{ project.id }}, this.value);"
                                                   style="width: 60px; text-align: center; margin: 0 2px;">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary rank-arrow-btn rank-down-btn" 
                                                    data-project-id="{{ project.id }}"
                                                    data-current-rank="{{ project.final_priority|default:0 }}"
                                                    title="Move down in priority (higher rank number)"
                                                    style="padding: 2px 6px; margin-left: 2px;">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="cc-empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <h4>No Final Governance Requests</h4>
                        <p>There are no requests currently in the final governance review phase.</p>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Project Details Modal -->
<div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-labelledby="projectDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #D09B2C 0%, #E6B84C 100%); color: black;">
                <h5 class="modal-title" id="projectDetailsModalLabel">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Project details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveChangesBtn" style="display: none;">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Final Scoring Details Modal -->
<div class="modal fade" id="finalScoringModal" tabindex="-1" aria-labelledby="finalScoringModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #D09B2C 0%, #E6B84C 100%); color: black;">
                <h5 class="modal-title" id="finalScoringModalLabel">Final Scoring Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="finalScoringModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function showProjectDetails(projectId) {
    // Load project details via AJAX
    fetch(`/${projectId}/scoring-details-modal/`)
        .then(response => {
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const project = data.project;
                const modalBody = document.querySelector('#projectDetailsModal .modal-body');
                const saveBtn = document.getElementById('saveChangesBtn');
                
                // Hide save button for project details view
                saveBtn.style.display = 'none';
                
                modalBody.innerHTML = `
                    <div class="project-title mb-3">${project.title}</div>
                    
                                                              <div class="request-details-section">
                         <div class="row">
                             <div class="col-12">
                                 <div class="detail-card">
                                     <div class="detail-title">Request Information</div>
                                                                           <div class="detail-content">
                                          <p><strong>Department:</strong> ${project.department || 'N/A'}</p>
                                          <p><strong>Request Type:</strong> ${project.project_type_display}</p>
                                          <p><strong>Status:</strong> ${project.status_display}</p>
                                          <p><strong>Priority:</strong> ${project.priority}</p>
                                      </div>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="row mt-3">
                             <div class="col-12">
                                 <div class="detail-card">
                                     <div class="detail-title">Contact Information</div>
                                     <div class="detail-content">
                                         <p><strong>Contact Person:</strong> ${project.contact_person ? project.contact_person : 'N/A'}</p>
                                         <p><strong>Contact Email:</strong> ${project.contact_email || 'N/A'}</p>
                                         <p><strong>Contact Phone:</strong> ${project.contact_phone || 'N/A'}</p>
                                         <p><strong>Submitted:</strong> ${project.submission_date_formatted || 'N/A'}</p>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                                                   <div class="row mt-3">
                              <div class="col-12">
                                  <div class="detail-card">
                                      <div class="detail-title">Description</div>
                                      <div class="detail-content">
                                          <p>${project.description || 'No description available.'}</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          
                          <div class="row mt-3">
                              <div class="col-12">
                                  <div class="detail-card">
                                      <div class="detail-title">Attachments</div>
                                      <div class="detail-content">
                                          ${project.files && project.files.length > 0 ? 
                                              project.files.map(file => `
                                                  <div class="attachment-item mb-2">
                                                      <a href="${file.file}" target="_blank" class="text-decoration-none">
                                                          <i class="fas fa-paperclip"></i> ${file.filename || 'Attachment'}
                                                      </a>
                                                  </div>
                                              `).join('') : 
                                              '<p class="text-muted">No attachments available.</p>'
                                          }
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('projectDetailsModal'));
                modal.show();
            } else {
                alert('Error loading project details');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading project details');
        });
}

// Function to open triage edit modal (same size as current MyGovernance modal)
function openTriageEditModal(projectId) {
    const modal = new bootstrap.Modal(document.getElementById('projectDetailsModal'));
    const modalBody = document.querySelector('#projectDetailsModal .modal-body');
    const modalTitle = document.querySelector('#projectDetailsModal .modal-title');
    const saveBtn = document.getElementById('saveChangesBtn');
    
    // Update modal title
    modalTitle.textContent = 'Edit Request - Triage';
    
    // Hide save button initially
    saveBtn.style.display = 'none';
    
    // Show loading state
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading edit form...</p>
        </div>
    `;
    
    // Show modal
    modal.show();
    
    // Load the edit form via AJAX (same as triage page)
    fetch(`/${projectId}/edit-form/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(html => {
            // Replace modal content with the edit form HTML
            modalBody.innerHTML = html;
            
            // Get the form element
            const form = modalBody.querySelector('form');
            
            if (form) {
                // Remove form action to prevent default submission
                form.removeAttribute('action');
                form.method = 'POST';
                
                // Show save button
                saveBtn.style.display = 'inline-block';
                
                // Add form submit handler
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitTriageEditForm(form, projectId);
                });
                
                // Add click handler to save button
                saveBtn.addEventListener('click', function() {
                    form.dispatchEvent(new Event('submit'));
                });
            } else {
                modalBody.innerHTML = '<div class="alert alert-danger">Error loading edit form</div>';
                saveBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading edit form:', error);
            modalBody.innerHTML = '<div class="alert alert-danger">Error loading edit form</div>';
            saveBtn.style.display = 'none';
        });
}

// Function to submit triage edit form
function submitTriageEditForm(form, projectId) {
    const formData = new FormData(form);
    const modalBody = document.querySelector('#projectDetailsModal .modal-body');
    const saveBtn = document.getElementById('saveChangesBtn');
    
    // Hide save button during save process
    saveBtn.style.display = 'none';
    
    // Show loading state
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Saving changes...</p>
        </div>
    `;
    
    fetch(`/${projectId}/update-ajax/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Success - show success message and close modal
            modalBody.innerHTML = `
                <div class="alert alert-success">
                    <h5>Success!</h5>
                    <p>Request updated successfully.</p>
                    <button type="button" class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-check"></i> Continue
                    </button>
                </div>
            `;
        } else {
            // Error - show error message
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <h5>Error Updating Request</h5>
                    <p>${data.message || 'An error occurred while saving the request.'}</p>
                    <button type="button" class="btn btn-outline-danger btn-sm mt-2" onclick="openTriageEditModal(${projectId})">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            `;
            // Don't show save button on error - user needs to reload form
        }
    })
    .catch(error => {
        console.error('Error submitting form:', error);
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                <h5>Error Updating Request</h5>
                <p>An error occurred while saving the request.</p>
                <button type="button" class="btn btn-outline-danger btn-sm mt-2" onclick="openTriageEditModal(${projectId})">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
        // Don't show save button on error - user needs to reload form
    });
}

// Function to open governance scoring modal
function openGovernanceScoringModal(projectId) {
    const modal = new bootstrap.Modal(document.getElementById('projectDetailsModal'));
    const modalBody = document.querySelector('#projectDetailsModal .modal-body');
    const modalTitle = document.querySelector('#projectDetailsModal .modal-title');
    const saveBtn = document.getElementById('saveChangesBtn');
    
    // Update modal title
    modalTitle.textContent = 'Project Scoring - Governance';
    
    // Hide save button for scoring modal
    saveBtn.style.display = 'none';
    
    // Show loading state
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading project details and scoring form...</p>
        </div>
    `;
    
    // Show modal
    modal.show();
    
    // Load project details and scoring form
    fetch(`/${projectId}/scoring-details-modal/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const project = data.project;
            const userScore = data.user_score;
            const condensedScores = data.condensed_scores;
            
            // Create the modal content with project details and scoring form
            modalBody.innerHTML = `
                <div class="mb-3">
                    <h5 class="mb-2">${project.title}</h5>
                    <p class="text-muted small mb-3">${project.description || 'No description available.'}</p>
                </div>
                
                <!-- Request Information Section -->
                <div class="request-info-section mb-3">
                    <h6 class="section-header small">Request Information</h6>
                    <div class="info-content compact">
                        <p class="mb-2"><strong>Request Type:</strong> ${project.project_type_display || 'N/A'}</p>
                        <p class="mb-2"><strong>Priority:</strong> ${project.priority || 'N/A'}</p>
                        <p class="mb-2"><strong>Status:</strong> ${project.status_display || 'N/A'}</p>
                        ${project.department ? `<p class="mb-2"><strong>Department:</strong> ${project.department}</p>` : ''}
                    </div>
                </div>
                
                <!-- Contact Information Section -->
                <div class="contact-info-section mb-3">
                    <h6 class="section-header small">Contact Information</h6>
                    <div class="info-content compact">
                        <p class="mb-2"><strong>Contact Person:</strong> ${project.contact_person || 'N/A'}</p>
                        <p class="mb-2"><strong>Contact Email:</strong> ${project.contact_email || 'N/A'}</p>
                        <p class="mb-2"><strong>Contact Phone:</strong> ${project.contact_phone || 'N/A'}</p>
                    </div>
                </div>
                
                <!-- Description Section -->
                <div class="description-section mb-3">
                    <h6 class="section-header small">Description</h6>
                    <div class="info-content compact">
                        <p class="mb-2">${project.description || 'No description available.'}</p>
                    </div>
                </div>
                
                <!-- Attachments Section -->
                <div class="attachments-section mb-3">
                    <h6 class="section-header small">Attachments</h6>
                    <div class="info-content compact">
                        ${project.project_file ? `
                            <div class="attachment-item">
                                <i class="fas fa-file-pdf text-danger"></i>
                                <a href="${project.project_file}" target="_blank" class="attachment-link">
                                    ${project.project_file.split('/').pop()}
                                </a>
                            </div>
                        ` : '<p class="text-muted mb-0">No attachments available.</p>'}
                    </div>
                </div>
                
                <!-- Scoring Form Section -->
                <div class="scoring-form-section">
                    <h6 class="section-header small">Score This Project</h6>
                    <form id="scoringForm">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Criteria</th>
                                        <th>Weight</th>
                                        <th>Your Score (1-5)</th>
                                        <th>Weighted Score</th>
                                    </tr>
                                </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                Strategic Alignment
                                                <i class="fas fa-info-circle info-icon" data-bs-toggle="tooltip" 
                                                   title="Measures how well the project aligns with institutional strategic goals and priorities. Consider the project's impact on key strategic initiatives and its contribution to long-term objectives."></i>
                                            </td>
                                            <td>20%</td>
                                            <td>
                                                <input type="number" name="strategic_alignment" id="strategic_alignment" 
                                                       class="form-control score-input" min="1" max="5" 
                                                       value="${userScore ? userScore.strategic_alignment || 1 : 1}"
                                                       onchange="calculateWeightedScore(this)">
                                            </td>
                                            <td>
                                                <span id="strategic_alignment_weighted" class="weighted-score" style="font-weight: bold; color: black;">0</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                Cost Benefit
                                                <i class="fas fa-info-circle info-icon" data-bs-toggle="tooltip" 
                                                   title="Evaluates the financial viability and return on investment. Consider both direct and indirect costs, potential savings, and the overall value proposition."></i>
                                            </td>
                                            <td>15%</td>
                                            <td>
                                                <input type="number" name="cost_benefit" id="cost_benefit" 
                                                       class="form-control score-input" min="1" max="5" 
                                                       value="${userScore ? userScore.cost_benefit || 1 : 1}"
                                                       onchange="calculateWeightedScore(this)">
                                            </td>
                                            <td>
                                                <span id="cost_benefit_weighted" class="weighted-score" style="font-weight: bold; color: black;">0</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                User Impact and Adoption
                                                <i class="fas fa-info-circle info-icon" data-bs-toggle="tooltip" 
                                                   title="Assesses the potential impact on users and the likelihood of successful adoption. Consider user needs, training requirements, and change management implications."></i>
                                            </td>
                                            <td>20%</td>
                                            <td>
                                                <input type="number" name="user_impact" id="user_impact" 
                                                       class="form-control score-input" min="1" max="5" 
                                                       value="${userScore ? userScore.user_impact || 1 : 1}"
                                                       onchange="calculateWeightedScore(this)">
                                            </td>
                                            <td>
                                                <span id="user_impact_weighted" class="weighted-score" style="font-weight: bold; color: black;">0</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                Ease of Implementation
                                                <i class="fas fa-info-circle info-icon" data-bs-toggle="tooltip" 
                                                   title="Evaluates the complexity and feasibility of implementation. Consider technical requirements, resource needs, timeline, and potential risks."></i>
                                            </td>
                                            <td>15%</td>
                                            <td>
                                                <input type="number" name="ease_of_implementation" id="ease_of_implementation" 
                                                       class="form-control score-input" min="1" max="5" 
                                                       value="${userScore ? userScore.ease_of_implementation || 1 : 1}"
                                                       onchange="calculateWeightedScore(this)">
                                            </td>
                                            <td>
                                                <span id="ease_of_implementation_weighted" class="weighted-score" style="font-weight: bold; color: black;">0</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                Vendor Reputation and Support
                                                <i class="fas fa-info-circle info-icon" data-bs-toggle="tooltip" 
                                                   title="Assesses the vendor's track record, reliability, and support capabilities. Consider past performance, customer service, and long-term viability."></i>
                                            </td>
                                            <td>10%</td>
                                            <td>
                                                <input type="number" name="vendor_reputation_support" id="vendor_reputation_support" 
                                                       class="form-control score-input" min="1" max="5" 
                                                       value="${userScore ? userScore.vendor_reputation_support || 1 : 1}"
                                                       onchange="calculateWeightedScore(this)">
                                            </td>
                                            <td>
                                                <span id="vendor_reputation_support_weighted" class="weighted-score" style="font-weight: bold; color: black;">0</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                Security and Compliance
                                                <i class="fas fa-info-circle info-icon" data-bs-toggle="tooltip" 
                                                   title="Evaluates security requirements and compliance obligations. Consider data protection, regulatory requirements, and risk management."></i>
                                            </td>
                                            <td>10%</td>
                                            <td>
                                                <input type="number" name="security_compliance" id="security_compliance" 
                                                       class="form-control score-input" min="1" max="5" 
                                                       value="${userScore ? userScore.security_compliance || 1 : 1}"
                                                       onchange="calculateWeightedScore(this)">
                                            </td>
                                            <td>
                                                <span id="security_compliance_weighted" class="weighted-score" style="font-weight: bold; color: black;">0</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                Student-Centered
                                                <i class="fas fa-info-circle info-icon" data-bs-toggle="tooltip" 
                                                   title="Measures the project's impact on student success and experience. Consider direct benefits to students, learning outcomes, and student engagement."></i>
                                            </td>
                                            <td>10%</td>
                                            <td>
                                                <input type="number" name="student_centered" id="student_centered" 
                                                       class="form-control score-input" min="1" max="5" 
                                                       value="${userScore ? userScore.student_centered || 1 : 1}"
                                                       onchange="calculateWeightedScore(this)">
                                            </td>
                                            <td>
                                                <span id="student_centered_weighted" class="weighted-score" style="font-weight: bold; color: black;">0</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Your Final Score:</strong></td>
                                            <td><span id="final_score_display" class="weighted-score" style="font-weight: bold; color: black;">0</span></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <div class="form-group mb-3">
                                <label for="scoring_notes">Scoring Notes</label>
                                <textarea name="scoring_notes" id="scoring_notes" class="form-control" 
                                        rows="4" placeholder="Add your detailed scoring notes here...">${userScore ? userScore.scoring_notes || '' : ''}</textarea>
                            </div>

                            <input type="hidden" name="final_score" id="final_score" value="${userScore ? userScore.final_score || 0 : 0}">
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="submit" class="btn" style="background-color: #D09B2C; border-color: #D09B2C; color: black;">
                                    <i class="fas fa-save me-2"></i>Save Scoring
                                </button>
                                <div id="saveStatus" class="text-muted"></div>
                            </div>
                        </form>
                    </div>
                </div>
                
                ${condensedScores && condensedScores.length > 0 ? `
                <!-- Condensed Scores Section for AI Governance Group Lead -->
                <div class="condensed-scores-section mt-4">
                    <h6 class="section-header small">AI Governance Group Scores</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Scored By</th>
                                    <th>Strategic</th>
                                    <th>Cost</th>
                                    <th>Impact</th>
                                    <th>Ease</th>
                                    <th>Vendor</th>
                                    <th>Security</th>
                                    <th>Student</th>
                                    <th>Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${condensedScores.map(score => `
                                    <tr>
                                        <td class="small">${score.scored_by}</td>
                                        <td class="text-center">${score.strategic_alignment || '-'}</td>
                                        <td class="text-center">${score.cost_benefit || '-'}</td>
                                        <td class="text-center">${score.user_impact || '-'}</td>
                                        <td class="text-center">${score.ease_of_implementation || '-'}</td>
                                        <td class="text-center">${score.vendor_reputation_support || '-'}</td>
                                        <td class="text-center">${score.security_compliance || '-'}</td>
                                        <td class="text-center">${score.student_centered || '-'}</td>
                                        <td class="text-center fw-bold">${score.final_score ? score.final_score.toFixed(2) : '-'}</td>
                                    </tr>
                                    <tr class="notes-row">
                                        <td colspan="9" class="small text-muted" style="padding-left: 1rem; padding-top: 0.25rem; padding-bottom: 0.5rem;">
                                            <strong>Notes:</strong> ${score.scoring_notes && score.scoring_notes.trim() ? 
                                                score.scoring_notes.trim() : 
                                                'Member did not provide any scoring notes.'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Add event listener for the scoring form
            document.getElementById('scoringForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveGovernanceScore(projectId);
            });
            
            // Initialize tooltips and calculate initial scores
            setTimeout(() => {
                // Initialize Bootstrap tooltips
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
                // Calculate initial weighted scores
                document.querySelectorAll('.score-input').forEach(input => {
                    calculateWeightedScore(input);
                });
            }, 100);
        })
        .catch(error => {
            console.error('Error loading project details:', error);
            modalBody.innerHTML = '<div class="alert alert-danger">Error loading project details and scoring form.</div>';
        });
}

// Function to calculate weighted scores for governance scoring
function calculateWeightedScore(input) {
    const score = parseFloat(input.value) || 1;
    let weight = 0.2; // Default weight for strategic alignment and user impact
    
    // Determine weight based on field name
    switch(input.name) {
        case 'strategic_alignment':
        case 'user_impact':
            weight = 0.2; // 20%
            break;
        case 'cost_benefit':
        case 'ease_of_implementation':
            weight = 0.15; // 15%
            break;
        case 'vendor_reputation_support':
        case 'security_compliance':
        case 'student_centered':
            weight = 0.1; // 10%
            break;
    }
    
    const weightedScore = score * weight;
    const weightedId = input.name + '_weighted';
    const weightedElement = document.getElementById(weightedId);
    
    if (weightedElement) {
        weightedElement.textContent = weightedScore.toFixed(2);
        // Ensure styling is maintained
        weightedElement.style.fontWeight = 'bold';
        weightedElement.style.color = 'black';
    }
    
    // Calculate final score
    calculateFinalScore();
}

// Function to calculate final score
function calculateFinalScore() {
    let totalScore = 0;
    
    // Sum all weighted scores
    document.querySelectorAll('.weighted-score').forEach(span => {
        if (span.id !== 'final_score_display') {
            totalScore += parseFloat(span.textContent) || 0;
        }
    });
    
    // Update final score display and hidden input
    const finalScoreElement = document.getElementById('final_score_display');
    finalScoreElement.textContent = totalScore.toFixed(2);
    finalScoreElement.style.fontWeight = 'bold';
    finalScoreElement.style.color = 'black';
    document.getElementById('final_score').value = totalScore.toFixed(2);
}

// Function to save governance score
function saveGovernanceScore(projectId) {
    const form = document.getElementById('scoringForm');
    const formData = new FormData(form);
    const saveStatus = document.getElementById('saveStatus');
    
    // Show saving status
    saveStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    fetch(`/${projectId}/score/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            saveStatus.innerHTML = '<i class="fas fa-check text-success"></i> Score saved successfully!';
            setTimeout(() => {
                saveStatus.innerHTML = '';
            }, 3000);
        } else {
            saveStatus.innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i> ${data.message || 'Error saving score'}`;
            setTimeout(() => {
                saveStatus.innerHTML = '';
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error saving score:', error);
        saveStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Error saving score';
        setTimeout(() => {
            saveStatus.innerHTML = '';
        }, 3000);
    });
}

// Function to move rank up (lower rank number = higher priority)
function moveRankUp(projectId, currentRank) {
    if (currentRank <= 1) {
        console.log('Project is already at the highest priority (rank 1)');
        return;
    }
    const newRank = currentRank - 1;
    console.log(`Moving project ${projectId} from rank ${currentRank} to rank ${newRank} (up in priority)`);
    updateFinalPriority(projectId, newRank);
}

// Function to move rank down (higher rank number = lower priority)
function moveRankDown(projectId, currentRank) {
    // Get the total number of projects to determine the maximum rank
    const totalProjects = document.querySelectorAll('.cc-project-row').length;
    if (currentRank >= totalProjects) {
        console.log('Project is already at the lowest priority (rank ' + totalProjects + ')');
        return;
    }
    const newRank = currentRank + 1;
    console.log(`Moving project ${projectId} from rank ${currentRank} to rank ${newRank} (down in priority)`);
    updateFinalPriority(projectId, newRank);
}

// Function to update final priority rank
function updateFinalPriority(projectId, priority) {
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    console.log(`Updating project ${projectId} to priority ${priority}`);
    
    // Check if user is still authenticated
    if (!csrfToken) {
        alert('Authentication error. Please refresh the page and try again.');
        return;
    }
    
    // Save the priority via AJAX
    fetch(`/${projectId}/update-final-priority/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            final_priority: priority
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (response.status === 302 || response.status === 401) {
            throw new Error('Authentication required');
        }
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            console.log(`Priority updated successfully for project ${projectId}`);
            
            // Broadcast the update to other tabs/windows
            broadcastPriorityUpdate(projectId, priority);
            
            // Refresh the table without full page reload
            console.log('Refreshing table to show updated ranks...');
            refreshFinalGovernanceTable();
        } else {
            console.error('Error updating priority:', data.error);
            alert('Error updating priority: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.message.includes('JSON.parse') || error.message.includes('Authentication required')) {
            alert('Authentication error. Please refresh the page and try again.');
        } else {
            alert('Error updating priority. Please try again. Error: ' + error.message);
        }
    });
}

// Function to broadcast priority updates to other tabs/windows
function broadcastPriorityUpdate(projectId, priority) {
    try {
        // Use Broadcast Channel API if available (modern browsers)
        if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('final-priority-updates');
            channel.postMessage({
                type: 'priority-updated',
                projectId: projectId,
                priority: priority,
                timestamp: Date.now()
            });
            channel.close();
        }
        
        // Fallback to localStorage events for older browsers
        const updateEvent = {
            type: 'priority-updated',
            projectId: projectId,
            priority: priority,
            timestamp: Date.now()
        };
        localStorage.setItem('final-priority-update', JSON.stringify(updateEvent));
        localStorage.removeItem('final-priority-update');
    } catch (error) {
        console.warn('Could not broadcast priority update:', error);
    }
}

// Function to listen for priority updates from other tabs/windows
function listenForPriorityUpdates() {
    try {
        // Listen for Broadcast Channel messages
        if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('final-priority-updates');
            channel.addEventListener('message', function(event) {
                if (event.data.type === 'priority-updated') {
                    console.log('Received priority update from another tab:', event.data);
                    refreshFinalGovernanceTable();
                }
            });
        }
        
        // Listen for localStorage events (fallback)
        window.addEventListener('storage', function(event) {
            if (event.key === 'final-priority-update' && event.newValue) {
                try {
                    const updateData = JSON.parse(event.newValue);
                    if (updateData.type === 'priority-updated') {
                        console.log('Received priority update from localStorage:', updateData);
                        refreshFinalGovernanceTable();
                    }
                } catch (error) {
                    console.warn('Error parsing priority update:', error);
                }
            }
        });
    } catch (error) {
        console.warn('Could not set up priority update listeners:', error);
    }
}

// Function to refresh the final governance table without full page reload
function refreshFinalGovernanceTable() {
    // Check if we're on a page with the final governance table
    const finalGovernanceTable = document.querySelector('.cc-final-scoring-table-container');
    if (finalGovernanceTable) {
        console.log('Refreshing final governance table...');
        
        // Fetch updated data from the server
        fetch(window.location.href.split('?')[0], {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Create a temporary DOM element to parse the new HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Find the new table content
            const newTableContainer = tempDiv.querySelector('.cc-final-scoring-table-container');
            if (newTableContainer) {
                // Replace the current table with the updated one
                finalGovernanceTable.innerHTML = newTableContainer.innerHTML;
                
                // Re-attach event listeners to the new input fields
                attachPriorityInputListeners();
                
                console.log('Table refreshed successfully');
            }
        })
        .catch(error => {
            console.error('Error refreshing table:', error);
            // Fallback to full page reload if AJAX refresh fails
            window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
        });
    }
}

// Function to attach event listeners to priority input fields and arrow buttons
function attachPriorityInputListeners() {
    const priorityInputs = document.querySelectorAll('.final-priority-input');
    priorityInputs.forEach(input => {
        input.addEventListener('change', function() {
            updateFinalPriority(this.dataset.projectId, this.value);
        });
        
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.blur(); // Trigger the change event
            }
        });
    });

    // Attach event listeners to arrow buttons
    const upButtons = document.querySelectorAll('.rank-up-btn');
    upButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent row click
            const projectId = this.dataset.projectId;
            const currentRank = parseInt(this.dataset.currentRank);
            moveRankUp(projectId, currentRank);
        });
    });

    const downButtons = document.querySelectorAll('.rank-down-btn');
    downButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent row click
            const projectId = this.dataset.projectId;
            const currentRank = parseInt(this.dataset.currentRank);
            moveRankDown(projectId, currentRank);
        });
    });
}

// Function to open final scoring modal
function openFinalScoringModal(projectId) {
    // Load project details via AJAX
    fetch(`/${projectId}/final-scoring-details-modal/`)
        .then(response => response.text())
        .then(html => {
            // Use the entire response as the modal content
            document.getElementById('finalScoringModalBody').innerHTML = html;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('finalScoringModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading project details:', error);
            document.getElementById('finalScoringModalBody').innerHTML = '<p>Error loading project details.</p>';
            const modal = new bootstrap.Modal(document.getElementById('finalScoringModal'));
            modal.show();
        });
}

// Initialize listeners when the page loads
document.addEventListener('DOMContentLoaded', function() {
    listenForPriorityUpdates();
    attachPriorityInputListeners();
});
</script>
{% endblock %}
